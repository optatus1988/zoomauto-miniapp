<script>
    const tg = window.Telegram.WebApp;
    tg.ready();
    tg.expand();

    // Маска для телефона
    function phoneMask(input) {
        let value = input.value.replace(/\D/g, '');
        if (value.length > 11) value = value.slice(0, 11);
        if (value.length === 0) { input.value = ''; return; }
        if (value[0] === '7' || value[0] === '8') value = value.slice(1);
        let formatted = '+7';
        if (value.length > 0) formatted += ' (' + value.slice(0, 3);
        if (value.length > 3) formatted += ') ' + value.slice(3, 6);
        if (value.length > 6) formatted += '-' + value.slice(6, 8);
        if (value.length > 8) formatted += '-' + value.slice(8, 10);
        input.value = formatted;
    }

    // Маска для даты
    function dateMask(input) {
        let value = input.value.replace(/\D/g, '');
        if (value.length > 8) value = value.slice(0, 8);
        let formatted = '';
        if (value.length > 0) formatted += value.slice(0, 2);
        if (value.length > 2) formatted += '.' + value.slice(2, 4);
        if (value.length > 4) formatted += '.' + value.slice(4, 8);
        input.value = formatted;
    }

    document.getElementById('phone').addEventListener('input', function() { phoneMask(this); });
    document.getElementById('dob').addEventListener('input', function() { dateMask(this); });
    document.getElementById('amount').addEventListener('input', function() { this.value = this.value.replace(/\D/g, ''); });

    document.getElementById('creditForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const fio = document.getElementById('fio').value.trim();
        const dob = document.getElementById('dob').value.trim();
        const phone = document.getElementById('phone').value.replace(/\D/g, '');
        const amount = document.getElementById('amount').value.trim();
        
        let valid = true;
        
        // Валидация
        if (fio.length < 5) { document.getElementById('fioGroup').classList.add('error'); valid = false; } 
        else { document.getElementById('fioGroup').classList.remove('error'); }
        
        if (dob.length !== 10) { document.getElementById('dobGroup').classList.add('error'); valid = false; } 
        else { document.getElementById('dobGroup').classList.remove('error'); }
        
        if (phone.length !== 11) { document.getElementById('phoneGroup').classList.add('error'); valid = false; } 
        else { document.getElementById('phoneGroup').classList.remove('error'); }
        
        if (amount.length < 5) { document.getElementById('amountGroup').classList.add('error'); valid = false; } 
        else { document.getElementById('amountGroup').classList.remove('error'); }
        
        if (!valid) return;
        
        const btn = document.getElementById('submitBtn');
        btn.disabled = true;
        btn.textContent = 'Отправка...';
        
        // ОТПРАВКА ДАННЫХ БОТУ
        tg.sendData(JSON.stringify({
            fio: fio,
            dob: dob,
            phone: '+7' + phone,
            amount: amount,
            username: tg.initDataUnsafe.user?.username || 'unknown',
            source: 'mini_app'
        }));
        
        // СРАЗУ ПОКАЗЫВАЕМ УСПЕХ (не ждем ответа)
        setTimeout(() => {
            document.getElementById('creditForm').style.display = 'none';
            document.getElementById('successMessage').style.display = 'block';
            tg.HapticFeedback.notificationOccurred('success');
            
            // ЗАКРЫВАЕМ ОКНО ЧЕРЕЗ 2 СЕКУНДЫ
            setTimeout(() => { tg.close(); }, 2000);
        }, 500);
    });
</script>
